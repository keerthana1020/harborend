apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "harbor.fullname" . }}-test-connection"
  labels:
    {{- include "harbor.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: test-connection
      image: busybox:1.35
      command: ['sh', '-c', 
        'set -ex;
         # Test Core Service
         wget -qO- http://{{ include "harbor.fullname" . }}-core:80/api/v2.0/systeminfo;
         # Test Database Connection
         nc -zv {{ include "harbor.fullname" . }}-postgresql 5432;
         # Verify EBS Storage (if using RWX)
         touch /data/testfile && echo "EBS write test passed";
         exit 0']
      volumeMounts:
        - name: test-storage
          mountPath: /data
  volumes:
    - name: test-storage
      persistentVolumeClaim:
        claimName: {{ include "harbor.fullname" . }}-registry-pvc # Tests EBS PVC
  restartPolicy: Never